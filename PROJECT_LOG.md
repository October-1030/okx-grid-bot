# OKX 智能网格量化交易系统 - 项目日志

## 项目概述

**项目名称**: OKX 智能网格量化交易系统
**版本**: v2.0
**创建日期**: 2025-12-26
**开发者**: 用户 + Claude Code
**目标**: 构建一个稳健的、会思考的加密货币自动交易系统

---

## 开发历程

### 第一阶段：需求确认 (2025-12-26)

**用户背景**:
- 新手，对量化交易不太了解
- 有 OKX API
- 希望系统稳健、考虑全面

**初始需求**:
- 自动交易系统
- 交易对: ETH-USDT
- 资金规模: 100-500 USDT
- 模式: 真实交易（非模拟盘）

**讨论要点**:
1. 解释了现货 vs 合约的区别，建议从现货开始
2. 说明了网格交易的原理和局限性（适合震荡市，单边行情会亏）
3. 用户强调需要系统"稳健"，而不是简单少投钱
4. 用户提出：政治会影响经济，需要全面考虑

### 第二阶段：架构设计

**核心理念**:
用户要求系统要"会思考"，考虑全方位因素。因此设计了多层次分析架构：

```
地缘政治 → 政策决策 → 宏观经济 → 金融市场 → 加密行业 → 市场情绪 → 技术面 → 币价
```

**设计原则**:
1. 不只看K线，还要看宏观环境
2. 综合多个因素做决策
3. 环境不对就减仓或暂停
4. 允许人工干预

### 第三阶段：系统实现

**实现的模块**:

1. **数据层** (data/)
   - `market_data.py`: 获取多周期K线数据 (1H/4H/1D/1W)
   - `indicators.py`: 计算技术指标 (SMA/EMA/RSI/MACD/布林带/ATR)
   - `external_data.py`: 获取外部情绪数据
     - 恐惧贪婪指数 (alternative.me API)
     - BTC市值占比 (CoinGecko API)
     - 资金费率 (OKX API)
     - 多空持仓比 (OKX API)

2. **分析层** (analysis/)
   - `trend.py`: 趋势分析
     - 基于均线判断 (MA20/MA50)
     - 基于MACD判断
     - 基于RSI判断超买超卖
     - 综合趋势评分
   - `volatility.py`: 波动率分析
     - 历史波动率计算
     - ATR百分比
     - 波动率突变检测
     - 网格间距建议
   - `macro_analysis.py`: 宏观环境综合分析
     - 整合趋势、波动、情绪
     - 输出环境评级 (极佳/良好/中性/谨慎/危险)
     - 输出建议仓位比例
     - 自动生成网格参数建议

3. **策略层** (strategy/)
   - `smart_grid.py`: 智能网格策略
     - 动态参数调整
     - 整合市场分析
     - 保留持仓的网格重置
   - `position_manager.py`: 仓位管理
     - 根据环境评分计算仓位
     - 金字塔式仓位分配
     - 加仓/减仓建议

4. **风控层** (risk/)
   - `risk_control.py`: 风险控制
     - 最大回撤保护 (默认10%)
     - 日亏损限制 (默认50 USDT)
     - 连续亏损次数限制
     - 价格异常波动检测
     - 持仓限制检查

5. **主程序**
   - `bot.py`: 基础版机器人
   - `smart_bot.py`: 智能版机器人 (推荐使用)

---

## 系统架构图

```
┌────────────────────────────────────────────────────────────────┐
│                          智能量化系统                           │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    外部数据接入层                        │  │
│  │  K线数据 | 恐惧贪婪 | 资金费率 | 多空比 | BTC市占率      │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    市场分析层                            │  │
│  │  趋势分析 | 波动率分析 | 情绪分析 | 综合评级             │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    策略决策层                            │  │
│  │  智能网格策略 | 仓位管理 | 参数动态调整                  │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    风控保护层                            │  │
│  │  回撤控制 | 日亏损限制 | 异常波动暂停 | 持仓限制         │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                    交易执行层                            │  │
│  │  OKX API 调用 | 订单管理 | 状态持久化                    │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 文件清单

| 文件 | 功能 | 状态 |
|------|------|------|
| `config.py` | 配置文件 | ✅ 完成 |
| `okx_api.py` | OKX API 封装 | ✅ 完成 |
| `logger.py` | 日志模块 | ✅ 完成 |
| `bot.py` | 基础版机器人 | ✅ 完成 |
| `smart_bot.py` | 智能版机器人 | ✅ 完成 |
| `data/market_data.py` | K线数据获取 | ✅ 完成 |
| `data/indicators.py` | 技术指标 | ✅ 完成 |
| `data/external_data.py` | 外部情绪数据 | ✅ 完成 |
| `analysis/trend.py` | 趋势分析 | ✅ 完成 |
| `analysis/volatility.py` | 波动率分析 | ✅ 完成 |
| `analysis/macro_analysis.py` | 宏观分析 | ✅ 完成 |
| `strategy/smart_grid.py` | 智能网格策略 | ✅ 完成 |
| `strategy/position_manager.py` | 仓位管理 | ✅ 完成 |
| `risk/risk_control.py` | 风控系统 | ✅ 完成 |

---

## 使用说明

### 首次使用

1. 复制 `.env.example` 为 `.env`
2. 填入 OKX API Key、Secret、Passphrase
3. 根据需要调整 `config.py` 中的参数
4. 运行 `pip install -r requirements.txt`

### 运行方式

```bash
# 只运行市场分析（不交易）
python smart_bot.py --analyze

# 启动智能交易机器人
python smart_bot.py

# 运行基础版机器人（不带智能分析）
python bot.py
```

### 配置要点

- `GRID_UPPER_PRICE` / `GRID_LOWER_PRICE`: 网格价格区间
- `GRID_COUNT`: 网格数量
- `AMOUNT_PER_GRID`: 每格投入金额
- `MAX_DRAWDOWN_PERCENT`: 最大回撤阈值
- `ANALYSIS_INTERVAL`: 市场分析间隔（秒）

---

## 待改进/未来方向

### 可以考虑添加的功能

1. **更多数据源**
   - 美元指数 (DXY)
   - 美股指数 (SPY/QQQ)
   - 宏观经济日历 API
   - 新闻情绪分析

2. **策略扩展**
   - 趋势跟踪策略（单边行情使用）
   - 动态止盈止损
   - 多币种组合

3. **通知功能**
   - Telegram 机器人通知
   - 邮件通知
   - Webhook 通知

4. **回测系统**
   - 历史数据回测
   - 策略效果评估
   - 参数优化

5. **Web 界面**
   - 实时监控面板
   - 参数配置界面
   - 交易历史图表

---

## 风险提示

1. **量化交易有风险**，本系统不保证盈利
2. **网格策略局限性**：适合震荡市，单边行情会亏损
3. **建议先用小资金测试**，确认系统正常后再增加资金
4. **API 安全**：不要泄露 API Key，建议设置 IP 白名单和只读权限
5. **程序 bug 风险**：建议定期检查运行状态

---

## 更新记录

| 日期 | 版本 | 更新内容 |
|------|------|----------|
| 2025-12-26 | v1.0 | 基础网格机器人完成 |
| 2025-12-26 | v2.0 | 升级为智能量化系统，新增市场分析、风控、仓位管理 |

---

*本日志由 Claude Code 自动生成，用于记录项目开发历程*
